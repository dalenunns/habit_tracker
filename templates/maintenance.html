{% extends "base.html" %}

{% block content %}
<div style="max-width: 900px; margin: 0 auto;">
    <h2>System Maintenance</h2>

    <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <h3>Configure Habits</h3>
        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px; flex-wrap: wrap;">
            <button id="emoji-trigger" type="button" style="background: #eee; font-size: 1.2rem; width: 50px; padding: 5px; border: 1px solid #ddd; border-radius: 5px;">ðŸ˜€</button>
            <input type="hidden" id="new-icon" value="ðŸ˜€">
            <input type="text" id="new-title" placeholder="Habit Title" style="flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            
            <select id="new-default-interval" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                <option value="0">No Default</option>
                {% for mins in [1, 3, 5, 10, 15, 20, 30, 40, 50, 60] %}
                <option value="{{ mins }}">{{ mins }}m</option>
                {% endfor %}
            </select>
            <button onclick="createHabit()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Add</button>
        </div>

        <ul style="list-style: none; padding: 0;">
            {% for habit in habits %}
            <li style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee;">
                <span>{{ habit.icon }} <strong>{{ habit.title }}</strong> ({{ habit.default_interval }}m)</span>
                <button onclick="deleteHabit({{ habit.id }})" style="background: #ffc107; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Delete</button>
            </li>
            {% endfor %}
        </ul>
    </div>

    <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <h3>Add Past Entry</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
            <div>
                <label>Habit:</label>
                <select id="manual-habit" style="width: 100%; padding: 8px;">
                    {% for habit in habits %}<option value="{{ habit.id }}">{{ habit.icon }} {{ habit.title }}</option>{% endfor %}
                </select>
            </div>
            <div>
                <label>Date & Time:</label>
                <input type="datetime-local" id="manual-time" style="width: 100%; padding: 8px;">
            </div>
            <div>
                <label>Mins:</label>
                <select id="manual-interval" style="width: 100%; padding: 8px;">
                    {% for mins in [1, 3, 5, 10, 15, 20, 30, 40, 50, 60] %}<option value="{{ mins }}">{{ mins }}m</option>{% endfor %}
                </select>
            </div>
        </div>
        <button onclick="submitManualEntry()" style="margin-top: 15px; background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Save Entry</button>
    </div>

    <h3>Manage Logs</h3>
    <div style="background: white; padding: 20px; border-radius: 12px; overflow-x: auto;">
        <table width="100%" style="border-collapse: collapse;">
            <tbody>
                {% for log in logs %}
                <tr id="row-{{ log.id }}" style="border-bottom: 1px solid #eee;">
                    <td style="padding: 10px;">{{ log.habit.title }}</td>
                    <td>{{ log.timestamp.strftime('%m-%d %H:%M') }}</td>
                    <td>{{ log.interval }}m</td>
                    <td><button onclick="deleteLog({{ log.id }})" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Delete</button></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script type="module">
    import { EmojiButton } from 'https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.4/dist/index.min.js';
    const picker = new EmojiButton();
    const trigger = document.querySelector('#emoji-trigger');
    const iconInput = document.querySelector('#new-icon');

    picker.on('emoji', selection => {
        trigger.innerText = selection.emoji;
        iconInput.value = selection.emoji;
    });
    trigger.addEventListener('click', () => picker.togglePicker(trigger));

    window.createHabit = async function() {
        const title = document.getElementById('new-title').value;
        const icon = document.getElementById('new-icon').value;
        const interval = document.getElementById('new-default-interval').value;
        if(!title) return alert("Title is required");

        await fetch(`${window.INGRESS_PATH}/api/habits`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ title, icon, default_interval: interval })
        });
        location.reload();
    }

    window.deleteHabit = async function(id) {
        if (!confirm("Delete this habit and all history?")) return;
        await fetch(`${window.INGRESS_PATH}/api/habit/${id}`, { method: 'DELETE' });
        location.reload();
    }

    window.submitManualEntry = async function() {
        const payload = {
            habit_id: document.getElementById('manual-habit').value,
            timestamp: document.getElementById('manual-time').value,
            interval: document.getElementById('manual-interval').value
        };
        if (!payload.timestamp) return alert("Select date/time");

        await fetch(`${window.INGRESS_PATH}/api/log/manual`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        location.reload();
    }

    window.deleteLog = async function(id) {
        if (!confirm("Delete this entry?")) return;
        const response = await fetch(`${window.INGRESS_PATH}/api/log/${id}`, { method: 'DELETE' });
        if (response.ok) document.getElementById(`row-${id}`).remove();
    }
</script>
{% endblock %}